# W100 Device Update Mechanisms

This document outlines the various automation paths and logical chains within `blueprint.yaml` that result in updates being sent to the W100 device. The W100 device is primarily updated to reflect the system's state on its display, showing temperature, fan speed, and humidity.

Updates are sent to the W100 device through a combination of Home Assistant services:
- `select.select_option`: To set the W100's display mode.
- `number.set_value`: To set the external temperature or humidity values that the W100 can display.
- `mqtt.publish`: To send raw data directly to the device via Zigbee2MQTT.

Below is a breakdown of each mechanism that triggers an update to the W100.

---

## 1. System Initialization on Home Assistant Startup

- **Trigger:** Home Assistant `start` event (`w100_init` trigger, line 233).
- **Purpose:** To ensure the W100 device displays meaningful data immediately after a system restart.

### Logic Path:

1.  When Home Assistant starts, the `w100_init` trigger fires.
2.  The automation (lines 690-763) checks the state of the `smart_thermostat_entity`.
    -   **If in Heat Mode** (line 693):
        -   It sets the W100 sensor to `external` mode (line 698).
        -   It sets the W100's external temperature display to the smart thermostat's target temperature (line 703).
        -   It publishes this temperature value via MQTT (line 707).
    -   **If in any other mode (Cool, Off, Idle)** (line 713):
        -   It sets the W100 sensor to `external` mode (line 715).
        -   It sets the W100's external temperature display to the current fan speed (line 719).
        -   It publishes this fan speed value via MQTT (line 724).
3.  The automation initializes the humidity display by setting `number.{{ w100_name }}_external_humidity` (line 725) and publishing the value via MQTT (line 734). It uses a `backup_humidity_entity` if provided, otherwise defaults to `50`.

---

## 2. General State Synchronization

- **Trigger:** `w100_sync` (lines 216-231). This is a versatile trigger that fires on changes to the smart thermostat's state, target temperature, current temperature, or the fan's mode.
- **Purpose:** To act as a catch-all mechanism that keeps the W100 display synchronized with Home Assistant's state, correcting any discrepancies that might occur.

### Logic Path:

1.  A change in the fan or thermostat state fires the `w100_sync` trigger.
2.  The automation (lines 604-688) evaluates the current state.
    -   **If in Heat Mode** (line 614): It checks if the W100 display is already showing the correct target temperature. If not, it updates the display by setting the sensor to `external` (line 626), setting the value (line 631), and publishing via MQTT (line 635).
    -   **If in Cool (Fan) Mode** (line 639): It checks if the W100 display is showing the correct fan speed. If not, it updates the display with the fan speed (lines 650-659).
    -   **If in another state (Off/Idle)** (line 662): It ensures the display is in `external` mode and shows the current fan speed (lines 679-688).

---

## 3. Remote Control Button Presses from W100

- **Triggers:**
    -   `w100_toggle`: `double_center` press (line 201).
    -   `w100_plus`: `single_plus` or `double_plus` press (lines 204, 207).
    -   `w100_minus`: `single_minus` or `double_minus` press (lines 210, 213).
- **Purpose:** To provide immediate visual feedback on the W100 display when the user interacts with its buttons.

### Logic Paths:

-   **Toggle Mode (`w100_toggle`, lines 429-474):**
    -   Toggles the `smart_thermostat_entity` between `heat` and `cool` (fan-only).
    -   If switched to `heat`, it updates the display to show the target temperature.
    -   If switched to `cool`, it updates the display to show the fan speed (lines 462-472).

-   **Increase Value (`w100_plus`, lines 476-538):**
    -   If in `heat` mode, it increases the target temperature and updates the W100 display with the new temperature (lines 493-506).
    -   If in `cool` (fan) mode, it increases the fan speed and updates the W100 display with the new fan speed (lines 521-536).

-   **Decrease Value (`w100_minus`, lines 540-602):**
    -   If in `heat` mode, it decreases the target temperature and updates the W100 display (lines 557-570).
    -   If in `cool` (fan) mode, it decreases the fan speed and updates the W100 display (lines 585-600).

---

## 4. Main Heat Mode Activation

- **Trigger:** `office_fan_heat_mode` (line 173), when the `heat_mode_boolean` is turned `on`.
- **Purpose:** To configure the fan for heating and immediately update the W100 display to show that it's in heating mode with the correct target temperature.

### Logic Path:

1.  The `heat_mode_boolean` is switched on.
2.  The automation (lines 254-318) sets the fan to heat mode, configures temperature and warm levels.
3.  It then forces a W100 display update (lines 302-318) by:
    -   Setting the sensor mode to `external` (line 304).
    -   Setting the external temperature display to the heating setpoint (line 309).
    -   Publishing the temperature via MQTT for redundancy (line 313).

---

## 5. Humidity Sensor Updates

- **Trigger:** `w100_humidity` (line 238), on state change of the `humidity_sensor`.
- **Purpose:** To keep the humidity reading on the W100 display current.

### Logic Path:

1.  The primary `humidity_sensor` reports a new value.
2.  The automation (lines 765-784) checks if the new humidity value is different from what's currently on the W100 display.
3.  If the values differ, it updates the `number.{{ w100_name }}_external_humidity` entity (line 778) and publishes the new value via MQTT (line 782) to sync the display.

---

## Root Cause of Display Bouncing Issue

The bouncing between temperature and fan speed values on the W100 display is caused by a fundamental mismatch between the automation's assumptions and the actual system configuration:

### The Problem:

1. **Mode Mismatch**: The automation assumes the smart thermostat can be in `cool` mode (line 641), but the actual smart thermostat only supports `heat` and `off` modes.

2. **Incorrect State Trigger**: The `smart_thermostat_state` trigger (lines 179-181) is configured to fire when the state changes to `"idle"`, but `idle` is not a valid climate entity state - it's an `hvac_action` attribute value.

3. **Race Conditions**: Multiple triggers can fire in rapid succession:
   - When the fan's `fan_mode` changes (line 228)
   - When the smart thermostat's state changes (line 222)
   - When the smart thermostat's temperature changes (line 219)
   - When the smart thermostat's current temperature changes (line 225)

### The Bouncing Mechanism:

Even when the smart thermostat remains in `heat` mode with `hvac_action: idle`, the following sequence can occur:

1. Any change to the fan or thermostat triggers `w100_sync`
2. The sync logic checks if state is `heat` (line 614) - this is TRUE
3. It sets the display to show temperature
4. However, if another trigger fires immediately after (e.g., fan mode change), it can cause the automation to run again
5. Due to timing issues or state evaluation differences, the logic might fall through to the default case
6. The default case (line 662) sets the display to show fan speed
7. This creates a rapid back-and-forth between temperature and fan speed displays

### The Solution:

To fix this issue, the automation needs to:
1. Remove the check for `cool` mode since the smart thermostat doesn't support it
2. Fix the `smart_thermostat_state` trigger to not look for `idle` state
3. Simplify the logic to clearly distinguish between:
   - Smart thermostat in `heat` mode → show temperature
   - Smart thermostat in `off` mode → show fan speed
4. Add debouncing or state stabilization to prevent rapid successive updates 